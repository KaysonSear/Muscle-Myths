#!/bin/bash
# ============================================================
# GitHub Issues 批量创建脚本
# 基于: migration_status.md 审计报告
# SRS参考: docs/MM_SRS2.md (V1.1) / docs/MM_SRS.md (V1.0)
# ============================================================

set -e

# 加载环境变量
source .cursor_secrets

# 设置仓库
REPO="KaysonSear/Muscle-Myths"

echo "🚀 开始创建 GitHub Issues..."
echo "📦 目标仓库: $REPO"
echo ""

# ============================================================
# 1. 技术栈维护 (低优先级 - 已超越V1.1要求)
# ============================================================

echo "📌 创建技术栈维护 Issues..."

gh issue create --repo "$REPO" \
  --title "chore: 安装 SRS v1.1 要求的缺失依赖" \
  --label "enhancement" \
  --body "## 📋 背景
根据 \`migration_status.md\` 审计报告 (3.3节)，以下 SRS v1.1 要求的依赖尚未安装。

## 🔴 优先级: 高

## 📦 缺失依赖列表

| 依赖项 | SRS章节 | 用途 |
|-------|---------|-----|
| \`@tanstack/react-query\` | 3.2.1 | 服务端状态管理 |
| \`@tanstack/react-table\` | 3.2.1 | 高级表格组件 |
| \`@dnd-kit/core\` | 3.2.1, 4.5.2 | 拖拽功能 (秩序表) |
| \`@dnd-kit/sortable\` | 3.2.1, 4.5.2 | 拖拽排序 |
| \`recharts\` | 3.2.1, 4.7.3 | 数据分析图表 |
| \`xlsx\` | 3.2.1, 4.5.3, 4.6.6 | Excel导出 |

## ✅ 执行命令
\`\`\`bash
cd frontend
pnpm add @dnd-kit/core @dnd-kit/sortable @tanstack/react-query @tanstack/react-table recharts xlsx
\`\`\`

## 📖 SRS 参考
- \`docs/MM_SRS2.md\` 第3.2.1节 - 前端核心库版本要求"

echo "✅ Issue 1/15 created"

gh issue create --repo "$REPO" \
  --title "chore: 移除版本前缀，使用精确版本号 (SRS v1.1 合规)" \
  --body "## 📋 背景
根据 \`docs/MM_SRS2.md\` 第 3.0.4 节「兼容性保障」要求：

> 在 package.json 中使用精确版本号（不使用 ^ 或 ~）

当前 \`package.json\` 中大部分依赖使用了 \`^\` 前缀。

## ⚪ 优先级: 低

## 🎯 任务
1. 移除 \`frontend/package.json\` 中所有 \`^\` 前缀
2. 移除 \`backend/package.json\` 中所有 \`^\` 前缀
3. 运行 \`pnpm install\` 确保锁文件更新

## 📖 SRS 参考
\`\`\`json
// docs/MM_SRS2.md 示例配置
{
  \"dependencies\": {
    \"next\": \"15.1.0\",        // 精确版本，非 ^15.1.0
    \"react\": \"19.0.0\",       // 精确版本
    \"typescript\": \"5.7.2\"    // 精确版本
  }
}
\`\`\`"

echo "✅ Issue 2/15 created"

# ============================================================
# 2. 实时计分系统 (模块6) - 高优先级
# ============================================================

echo "📌 创建计分系统 Issues..."

gh issue create --repo "$REPO" \
  --title "feat(scoring): 实现计分界面主体 - 裁判评分输入表格" \
  --label "enhancement" \
  --body "## 📋 功能描述
实现实时计分界面的核心组件：裁判评分输入表格。

## 🔴 优先级: 关键 (Critical)

## 🎯 需求来源
- **SRS章节**: FR-SCORING-001, FR-SCORING-002
- **审计状态**: ❌ Missing

## 📐 界面设计 (参考 SRS 8.7.2)
\`\`\`
┌─────────────────────────────────────────────────────┐
│  2026北京新星联赛 - 计分模式                          │
│  青年传统E组                          [导出计分表]    │
├─────────────────────────────────────────────────────┤
│  号码牌 姓名  裁判1 裁判2 裁判3 裁判4 裁判5 总分 排名│
│  ──────────────────────────────────────────────────│
│  001   张三   [1]   [2]   [1]   [1]   [2]   5    1 │
│  002   李四   [2]   [1]   [2]   [2]   [1]   6    2 │
│  003   王五   [3]   [3]   [3]   [3]   [3]   12   3 │
└─────────────────────────────────────────────────────┘
\`\`\`

## ✅ 验收标准
- [ ] 创建页面 \`/dashboard/events/[id]/scoring/page.tsx\`
- [ ] 从秩序表加载选手列表
- [ ] 裁判评分输入框支持数字输入
- [ ] Tab键快速切换输入框
- [ ] 实时显示总分和排名

## 📖 SRS 详细规则 (MM_SRS.md 4.6.2)
> 根据健美比赛规则，裁判按选手应得排名打分：第一名得1分，第二名得2分，以此类推"

echo "✅ Issue 3/15 created"

gh issue create --repo "$REPO" \
  --title "feat(scoring): 实现裁判人数设置对话框" \
  --label "enhancement" \
  --body "## 📋 功能描述
进入计分模式前，弹出对话框让用户选择裁判人数。

## 🔴 优先级: 高

## 🎯 需求来源
- **SRS章节**: FR-SCORING-001
- **审计状态**: ❌ Missing

## 📐 交互流程
1. 点击「启动计分模式」按钮
2. 弹出对话框：「请选择裁判人数（1-7人）」
3. 确认后，计分表显示对应数量的裁判列

## ✅ 验收标准
- [ ] Dialog 组件实现
- [ ] 裁判人数选项：1, 3, 5, 7（奇数）
- [ ] 选择后存储到状态/URL参数
- [ ] 计分表动态渲染对应列数"

echo "✅ Issue 4/15 created"

gh issue create --repo "$REPO" \
  --title "feat(scoring): 实现去极值计算与同分高亮" \
  --label "enhancement" \
  --body "## 📋 功能描述
实现前端计分展示的核心逻辑：去极值显示、同分高亮。

## 🔴 优先级: 高

## 🎯 需求来源
- **SRS章节**: FR-SCORING-003
- **审计状态**: 后端已实现，前端 ❌ Missing

## 📐 计算规则 (MM_SRS.md 4.6.3)
> 对于5或7位裁判，去掉一个最高分和一个最低分；对于9位裁判，去掉两个最高分和两个最低分。
> 将剩余分数相加，得到**总分**。
> 分数越低排名越高（1分最好）。

## ✅ 验收标准
- [ ] 被去掉的分数以删除线或灰色显示
- [ ] 总分实时更新
- [ ] 同分选手行以**红色背景高亮**
- [ ] 显示提示：「存在同分选手，请裁判进行额外评判」"

echo "✅ Issue 5/15 created"

gh issue create --repo "$REPO" \
  --title "feat(scoring): 实现计分结果导出 Excel" \
  --label "enhancement" \
  --body "## 📋 功能描述
将计分结果导出为 xlsx 文件，每个组别单独一个 Sheet。

## 🔴 优先级: 高

## 🎯 需求来源
- **SRS章节**: FR-SCORING-006
- **审计状态**: ❌ Missing (依赖 xlsx 库)

## 📐 导出规格 (MM_SRS.md 4.6.6)
- 文件名：\`计分表_赛事名称_组别_日期.xlsx\`
- 每个「真实组别」导出为单独的 Sheet
- 可选字段：号码牌、姓名、真实组别、各裁判评分、总分、排名
- 可选隐藏身份证号

## ✅ 验收标准
- [ ] 安装 \`xlsx\` (SheetJS) 依赖
- [ ] 导出按钮触发下载
- [ ] 多 Sheet 导出
- [ ] 文件可在 WPS/Excel 正常打开"

echo "✅ Issue 6/15 created"

# ============================================================
# 3. 秩序表管理 (模块5) - 高优先级
# ============================================================

echo "📌 创建秩序表管理 Issues..."

gh issue create --repo "$REPO" \
  --title "feat(lineup): 实现秩序表可视化编辑界面" \
  --label "enhancement" \
  --body "## 📋 功能描述
创建秩序表可视化编辑页面，展示选手出场顺序。

## 🔴 优先级: 关键 (Critical)

## 🎯 需求来源
- **SRS章节**: FR-LINEUP-002
- **审计状态**: ❌ Missing

## 📐 界面设计 (MM_SRS.md 4.5.2)
- 秩序表以**类似表格**的形式展示
- 每一行代表一个选手
- 列：序号、号码牌、姓名、真实组别、操作

## ✅ 验收标准
- [ ] 创建页面 \`/dashboard/events/[id]/lineup/page.tsx\`
- [ ] 调用 \`GET /api/lineups/:event_id\` 加载数据
- [ ] 按组别分组显示
- [ ] 兼项选手未展示项目以**灰色背景**标记"

echo "✅ Issue 7/15 created"

gh issue create --repo "$REPO" \
  --title "feat(lineup): 实现拖拽排序功能 (@dnd-kit)" \
  --label "enhancement" \
  --body "## 📋 功能描述
使用 @dnd-kit 实现秩序表的拖拽排序功能。

## 🔴 优先级: 高

## 🎯 需求来源
- **SRS章节**: FR-LINEUP-002
- **审计状态**: ❌ Missing (依赖未安装)

## 📐 交互设计 (MM_SRS.md 4.5.2)
> 长按某一行（移动端）或点击拖拽图标（桌面端）
> 拖动该行至目标位置
> 释放后，自动重新编号

## ✅ 验收标准
- [ ] 安装 \`@dnd-kit/core\` 和 \`@dnd-kit/sortable\`
- [ ] 拖拽手柄图标
- [ ] 拖拽流畅无卡顿
- [ ] 拖动后序号自动更新
- [ ] 调用 \`PUT /api/lineups/:event_id\` 保存"

echo "✅ Issue 8/15 created"

gh issue create --repo "$REPO" \
  --title "feat(lineup): 实现秩序表导出 Excel" \
  --label "enhancement" \
  --body "## 📋 功能描述
将秩序表导出为 xlsx 文件。

## 🔴 优先级: 高

## 🎯 需求来源
- **SRS章节**: FR-LINEUP-003
- **审计状态**: ❌ Missing

## 📐 导出规格 (MM_SRS.md 4.5.3)
- 文件名：\`秩序表_赛事名称_日期.xlsx\`
- 可选字段：序号、号码牌、姓名、真实组别、身份证号等
- 提供「隐藏身份证号」复选框

## ✅ 验收标准
- [ ] 导出选项对话框
- [ ] 字段勾选
- [ ] 敏感信息脱敏选项
- [ ] 兼容 WPS/Excel"

echo "✅ Issue 9/15 created"

# ============================================================
# 4. 数据分析 (模块7) - 中优先级
# ============================================================

echo "📌 创建数据分析 Issues..."

gh issue create --repo "$REPO" \
  --title "feat(analytics): 实现数据分析模块 - 页面框架与统计指标" \
  --label "enhancement" \
  --body "## 📋 功能描述
创建数据分析页面，展示核心统计指标卡片。

## 🟡 优先级: 中

## 🎯 需求来源
- **SRS章节**: FR-ANALYTICS-001, FR-ANALYTICS-002
- **审计状态**: ❌ Missing (整个模块)

## 📐 核心指标 (MM_SRS.md 4.7.2)
- **总报名人数**（去重）
- **总报名人次**（含兼项）
- **平均兼项数**
- **人均消费金额**

## ✅ 验收标准
- [ ] 创建页面 \`/dashboard/analytics/page.tsx\`
- [ ] 添加导航入口「数据分析」
- [ ] 赛事选择器（单选/多选/全选）
- [ ] 统计卡片组件
- [ ] 后端 API \`GET /api/analytics/summary\`"

echo "✅ Issue 10/15 created"

gh issue create --repo "$REPO" \
  --title "feat(analytics): 实现数据可视化饼图 (Recharts)" \
  --label "enhancement" \
  --body "## 📋 功能描述
使用 Recharts 实现多维度数据分布饼图。

## 🟡 优先级: 中

## 🎯 需求来源
- **SRS章节**: FR-ANALYTICS-003
- **审计状态**: ❌ Missing (依赖未安装)

## 📐 饼图类型 (MM_SRS.md 4.7.3)
- 性别分布：男性 vs 女性
- 国籍分布
- 年龄分布
- 一级组别分布
- 二级组别分布
- 三级组别分布
- 增值服务分布

## 📐 样式要求
> 饼图位于左侧，文字说明位于右侧
> 颜色：红蓝配色（符合品牌色）
> 支持鼠标悬停显示详细数据

## ✅ 验收标准
- [ ] 安装 \`recharts\`
- [ ] PieChart 组件封装
- [ ] 响应式布局
- [ ] 点击扇区添加筛选条件（交互增强）"

echo "✅ Issue 11/15 created"

# ============================================================
# 5. 选手管理完善 (模块2) - 中优先级
# ============================================================

echo "📌 创建选手管理完善 Issues..."

gh issue create --repo "$REPO" \
  --title "feat(athlete): 实现选手详情页与参赛历史" \
  --label "enhancement" \
  --body "## 📋 功能描述
创建选手详情页，展示完整信息和参赛历史。

## 🟡 优先级: 中

## 🎯 需求来源
- **SRS章节**: FR-ATHLETE-003
- **审计状态**: ❌ Missing

## 📐 页面内容 (MM_SRS.md 4.2.3)
1. **基本信息展示**：所有选手字段
2. **参赛历史**：赛事名称、日期、地点、参赛组别、成绩/排名
3. **增值服务记录**：以标签形式展示
4. **快速操作**：「为该选手报名新赛事」按钮

## ✅ 验收标准
- [ ] 创建页面 \`/dashboard/athletes/[id]/page.tsx\`
- [ ] 关联查询 Registration 数据
- [ ] 点击赛事名称可跳转
- [ ] 快捷报名入口"

echo "✅ Issue 12/15 created"

gh issue create --repo "$REPO" \
  --title "feat(athlete): 实现身份证号自动解析生日/性别" \
  --label "enhancement" \
  --body "## 📋 功能描述
当证件类型为「身份证」时，自动从证件号提取生日和性别。

## 🟡 优先级: 中

## 🎯 需求来源
- **SRS章节**: FR-ATHLETE-002
- **审计状态**: ❌ Missing

## 📐 解析规则 (MM_SRS.md 4.2.2)
> 生日格式：YYYYMMDD（从身份证号第7-14位提取）
> 性别：根据身份证号第17位判断（奇数为男，偶数为女）

## ✅ 验收标准
- [ ] 前端实时解析（输入时触发）
- [ ] 自动填充生日字段
- [ ] 自动设置性别单选
- [ ] 年龄根据生日实时计算"

echo "✅ Issue 13/15 created"

# ============================================================
# 6. 报名管理完善 (模块4) - 中优先级
# ============================================================

echo "📌 创建报名管理完善 Issues..."

gh issue create --repo "$REPO" \
  --title "feat(registration): 实现报名编辑与删除功能" \
  --label "enhancement" \
  --body "## 📋 功能描述
完善报名管理的编辑和删除功能。

## 🟡 优先级: 中

## 🎯 需求来源
- **SRS章节**: FR-REGISTRATION-003
- **审计状态**: ❌ Missing (无API实现)

## 📐 功能要求 (MM_SRS.md 4.4.3)
1. **编辑报名**：
   - 可修改参赛组别、增值服务
   - 费用自动重新计算
2. **删除报名**：
   - 弹出确认对话框
   - 确认后删除记录

## ✅ 验收标准
- [ ] 后端 \`PUT /api/registrations/:id\`
- [ ] 后端 \`DELETE /api/registrations/:id\`
- [ ] 前端编辑表单
- [ ] 删除确认对话框"

echo "✅ Issue 14/15 created"

# ============================================================
# 7. 赛事管理完善 (模块3) - 低优先级
# ============================================================

echo "📌 创建赛事管理完善 Issues..."

gh issue create --repo "$REPO" \
  --title "feat(event): 实现裁判信息管理与封面图上传" \
  --label "enhancement" \
  --body "## 📋 功能描述
完善赛事创建/编辑页面的裁判管理和封面图功能。

## ⚪ 优先级: 低

## 🎯 需求来源
- **SRS章节**: FR-EVENT-002
- **审计状态**: 🚧 Partial (后端有字段，前端未集成)

## 📐 功能要求 (MM_SRS.md 4.3.2)
1. **裁判信息管理**：
   - 点击「添加裁判」按钮，动态添加裁判表单
   - 每位裁判可上传头像（可选）
   - 支持删除裁判
2. **封面图上传**：
   - 支持拖拽上传或点击选择
   - 上传后显示预览
   - 格式：jpg/png，最大5MB

## ✅ 验收标准
- [ ] 动态裁判表单组件
- [ ] 图片上传预览
- [ ] 调用 \`POST /api/upload/image\`
- [ ] 数据正确保存到 Event.judges"

echo "✅ Issue 15/15 created"

# ============================================================
# 完成
# ============================================================

echo ""
echo "=============================================="
echo "🎉 所有 Issues 创建完成！"
echo "=============================================="
echo ""
echo "📊 Issue 统计："
echo "   - 技术栈维护: 2"
echo "   - 计分系统: 4"
echo "   - 秩序表管理: 3"
echo "   - 数据分析: 2"
echo "   - 选手管理: 2"
echo "   - 报名管理: 1"
echo "   - 赛事管理: 1"
echo ""
echo "🔗 查看 Issues: $REPO_URL/issues"
